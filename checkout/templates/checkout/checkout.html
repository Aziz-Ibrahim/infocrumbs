{% extends "base.html" %}
{% load static %}

{% block title %}Checkout - {{ plan.name }}{% endblock %}

{% block content %}
<div class="container">
    <h2>Confirm your subscription</h2>
    <p>
        You selected the <strong>{{ plan.name }}</strong> plan
    </p>
    <p>
        Renews <strong>{{ frequency.name }}</strong>, starting from today.
    </p>
    <p>
        Amount to be paid: <strong>Â£{{ price }}</strong>
    </p>

    <form id="payment-form">
        <div class="form-group">
            <label for="card-element">Card Details</label>
            <div id="card-element" class="stripe-card-element-wrapper">
                </div>
        </div>
        <div id="card-errors" role="alert" class="text-danger mt-2"></div>
        <button type="submit" class="neon-button mt-3">Pay</button>
    </form>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://js.stripe.com/v3/"></script>
<script>
    const stripe = Stripe("{{ STRIPE_PUBLIC_KEY }}");
    const elements = stripe.elements();

    // Define the style for Stripe's elements to match Bootstrap/Crispy Forms
    const cardStyle = {
        base: {
            color: '#aab7c4',
            fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol"',
            fontSmoothing: 'antialiased',
            fontSize: '16px',
            '::placeholder': {
                color: '#aab7c4'
            },
        },
        invalid: {
            color: '#fa755a',
            iconColor: '#fa755a'
        },
    };

    // Create the card element with custom style and hide postal code
    const card = elements.create("card", {
        style: cardStyle,
        hidePostalCode: true // This hides the zip code field
    });
    card.mount("#card-element");

    // Event listener for card errors
    card.addEventListener('change', function(event) {
        const displayError = document.getElementById('card-errors');
        if (event.error) {
            displayError.textContent = event.error.message;
            displayError.classList.add('text-danger');
        } else {
            displayError.textContent = '';
            displayError.classList.remove('text-danger');
        }
    });

    const form = document.getElementById("payment-form");
    form.addEventListener("submit", async (e) => {
        e.preventDefault();

        // Disable button and show loading state
        const payButton = form.querySelector('button[type="submit"]');
        payButton.disabled = true;
        payButton.textContent = 'Processing...';

        try {
            const response = await fetch("{% url 'create_payment_intent' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: JSON.stringify({
                    plan_id: "{{ plan_id }}",
                    frequency_id: "{{ frequency_id }}"
                })
            });

            const data = await response.json();

            if (data.error) {
                document.getElementById("card-errors").textContent = data.error;
                document.getElementById("card-errors").classList.add('text-danger');
                return; // Stop execution if there's an error from the server
            }

            const result = await stripe.confirmCardPayment(data.clientSecret, {
                payment_method: {
                    card: card
                }
            });

            if (result.error) {
                document.getElementById("card-errors").textContent = result.error.message;
                document.getElementById("card-errors").classList.add('text-danger');
            } else {
                if (result.paymentIntent.status === "succeeded") {
                    window.location.href = "{% url 'account_profile' %}";
                }
            }
        } catch (error) {
            document.getElementById("card-errors").textContent = 'An unexpected error occurred. Please try again.';
            document.getElementById("card-errors").classList.add('text-danger');
            console.error('Payment form submission error:', error);
        } finally {
            // Re-enable button and reset text regardless of success/failure (unless redirected)
            payButton.disabled = false;
            payButton.textContent = 'Pay';
        }
    });
</script>
{% endblock %}
